<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Toxicity Detector | Live Demo</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --bg-dark: #0f111a; /* Deep matte black/blue */
            --panel-bg: #1a1d2d; /* Slightly lighter panel */
            --border: #2f344a;
            --text-primary: #e2e8f0;
            --text-secondary: #94a3b8;
            --accent-safe: #10b981; /* Emerald Green */
            --accent-toxic: #ef4444; /* Rose Red */
            --bubble-self: #3b82f6; /* Blue for input */
            --bubble-received: #2d3748;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', system-ui, sans-serif; }

        body {
            background: var(--bg-dark);
            color: var(--text-primary);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* --- Header --- */
        header {
            padding: 15px 25px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--panel-bg);
        }
        .status-dot {
            height: 8px; width: 8px; border-radius: 50%;
            background: var(--text-secondary);
            display: inline-block;
            transition: background 0.3s;
        }
        .status-dot.active { background: var(--accent-safe); box-shadow: 0 0 10px var(--accent-safe); }

        /* --- Grid Layout --- */
        .grid-container {
            display: grid;
            grid-template-columns: 1fr 380px 1fr; /* Left, Center (Fixed), Right */
            flex: 1;
            height: 100%;
            overflow: hidden;
        }

        .panel {
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            position: relative;
        }
        .panel:last-child { border-right: none; }

        .panel-header {
            padding: 15px;
            font-size: 0.85rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-secondary);
            border-bottom: 1px solid var(--border);
            background: rgba(15, 17, 26, 0.5);
        }

        /* --- Chat Areas (Left & Right) --- */
        .chat-scroll {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .bubble {
            max-width: 85%;
            padding: 12px 16px;
            border-radius: 12px;
            font-size: 0.95rem;
            line-height: 1.5;
            position: relative;
            animation: popIn 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        /* Left Panel - Sender Bubbles */
        .sent {
            align-self: flex-end;
            background: var(--panel-bg);
            border: 1px solid var(--border);
            color: var(--text-primary);
        }
        
        /* Dynamic Styles for Toxicity Feedback */
        .sent.pending { opacity: 0.6; }
        .sent.safe { border-color: var(--accent-safe); }
        .sent.toxic { 
            border-color: var(--accent-toxic); 
            background: rgba(239, 68, 68, 0.1);
            color: var(--accent-toxic);
        }

        /* Right Panel - Receiver Bubbles */
        .received {
            align-self: flex-start;
            background: var(--bubble-received);
            border-left: 3px solid var(--accent-safe);
        }
        .received.modified {
            border-left: 3px solid var(--text-secondary);
            font-style: italic;
        }

        /* --- Center Panel (Detector) --- */
        .center-content {
            padding: 30px 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            gap: 30px;
        }

        .status-card {
            width: 100%;
            background: var(--panel-bg);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 25px;
            text-align: center;
            transition: all 0.3s ease;
        }

        .score-display {
            font-size: 4rem;
            font-weight: 800;
            font-family: monospace;
            margin: 10px 0;
            color: var(--text-secondary);
        }
        .score-label { font-size: 0.8rem; text-transform: uppercase; color: var(--text-secondary); }

        .analysis-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
        }
        
        .badge {
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            background: var(--border);
        }

        /* State Classes */
        .status-safe .score-display { color: var(--accent-safe); }
        .status-safe .badge { background: rgba(16, 185, 129, 0.2); color: var(--accent-safe); }
        
        .status-toxic .score-display { color: var(--accent-toxic); }
        .status-toxic .badge { background: rgba(239, 68, 68, 0.2); color: var(--accent-toxic); }

        /* --- Input Area --- */
        .input-area {
            padding: 20px;
            background: var(--panel-bg);
            border-top: 1px solid var(--border);
        }
        .input-wrapper {
            display: flex;
            gap: 10px;
            background: var(--bg-dark);
            padding: 5px;
            border-radius: 12px;
            border: 1px solid var(--border);
        }
        input {
            flex: 1;
            background: transparent;
            border: none;
            color: white;
            padding: 12px 15px;
            outline: none;
            font-size: 1rem;
        }
        button {
            background: var(--bubble-self);
            border: none;
            color: white;
            padding: 0 25px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: opacity 0.2s;
        }
        button:hover { opacity: 0.9; }

        @keyframes popIn { from { opacity: 0; transform: translateY(10px) scale(0.95); } to { opacity: 1; transform: translateY(0) scale(1); } }
    </style>
</head>
<body>

    <header>
        <div>
            <i class="fas fa-shield-virus" style="color: var(--accent-safe); margin-right: 10px;"></i>
            <strong>Toxicity Guard</strong> <span style="opacity: 0.5;">| Live Monitor</span>
        </div>
        <div class="status-dot" id="wsStatus"></div>
    </header>

    <div class="grid-container">
        
        <div class="panel">
            <div class="panel-header">Sender Input</div>
            <div class="chat-scroll" id="senderLog">
                </div>
            <div class="input-area">
                <div class="input-wrapper">
                    <input type="text" id="msgInput" placeholder="Type a message..." autocomplete="off">
                    <button onclick="send()" id="sendBtn"><i class="fas fa-paper-plane"></i></button>
                </div>
            </div>
        </div>

        <div class="panel">
            <div class="panel-header">AI Analysis</div>
            <div class="center-content">
                <div class="status-card" id="mainStatusCard">
                    <div class="score-label">Toxicity Score</div>
                    <div class="score-display" id="scoreVal">0.00</div>
                    <div class="badge" id="statusBadge">Idle</div>
                </div>
                
                <div style="width: 100%; border-top: 1px solid var(--border); margin: 10px 0;"></div>
                
                <div style="text-align: center; color: var(--text-secondary); font-size: 0.9rem;">
                    <p style="margin-bottom: 10px;">Processing Logic:</p>
                    <div style="display: flex; justify-content: center; gap: 10px; font-size: 0.8rem;">
                        <span style="color: var(--accent-safe)"> < 0.50 Pass</span>
                        <span style="color: var(--border)">|</span>
                        <span style="color: var(--accent-toxic)"> â‰¥ 0.50 Rewrite</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="panel">
            <div class="panel-header">Receiver Output</div>
            <div class="chat-scroll" id="receiverLog">
                </div>
        </div>

    </div>

    <script>
        const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const ws = new WebSocket(`${wsProtocol}//${window.location.host}/ws/moderator`);
        
        const ui = {
            input: document.getElementById('msgInput'),
            senderLog: document.getElementById('senderLog'),
            receiverLog: document.getElementById('receiverLog'),
            scoreVal: document.getElementById('scoreVal'),
            statusBadge: document.getElementById('statusBadge'),
            statusCard: document.getElementById('mainStatusCard'),
            wsStatus: document.getElementById('wsStatus')
        };

        // Track messages to retrospective update styles
        // Simple queue since backend processes in order
        let messageQueue = []; 

        ws.onopen = () => {
            ui.wsStatus.classList.add('active');
            console.log('Connected to Guard');
        };

        ws.onclose = () => ui.wsStatus.classList.remove('active');

        ws.onmessage = (event) => {
            const data = JSON.parse(event.data);
            handleResponse(data);
        };

        function send() {
            const text = ui.input.value.trim();
            if (!text) return;

            // 1. Add visual placeholder to Sender Log
            const msgId = Date.now();
            const bubble = document.createElement('div');
            bubble.className = 'bubble sent pending';
            bubble.id = `msg-${msgId}`;
            bubble.textContent = text;
            ui.senderLog.appendChild(bubble);
            ui.senderLog.scrollTop = ui.senderLog.scrollHeight;
            
            // Track this ID
            messageQueue.push({ id: msgId, text: text });

            // 2. Send to backend
            ws.send(JSON.stringify({ text: text }));
            
            ui.input.value = '';
        }

        function handleResponse(data) {
            const { original, final, toxicity, moderated } = data;
            
            // 1. Update Sender Visuals (Find matching message)
            // We scan queue for the original text matching the response
            const matchIndex = messageQueue.findIndex(m => m.text === original);
            if (matchIndex !== -1) {
                const msgData = messageQueue[matchIndex];
                const el = document.getElementById(`msg-${msgData.id}`);
                if (el) {
                    el.classList.remove('pending');
                    el.classList.add(moderated ? 'toxic' : 'safe');
                    
                    if (moderated) {
                        el.innerHTML += ` <i class="fas fa-exclamation-circle" style="margin-left:5px;"></i>`;
                    }
                }
                // Remove from queue
                messageQueue.splice(matchIndex, 1);
            }

            // 2. Update Center Panel (Analysis)
            ui.scoreVal.textContent = toxicity.toFixed(2);
            ui.statusCard.className = 'status-card'; // Reset
            ui.statusCard.classList.add(moderated ? 'status-toxic' : 'status-safe');
            
            ui.statusBadge.innerHTML = moderated 
                ? `<i class="fas fa-biohazard"></i> Toxic Detected`
                : `<i class="fas fa-check"></i> Safe`;

            // 3. Update Receiver Log
            const rxBubble = document.createElement('div');
            rxBubble.className = `bubble received ${moderated ? 'modified' : ''}`;
            rxBubble.innerHTML = final;
            
            if(moderated) {
                rxBubble.innerHTML += `<div style="font-size: 0.7rem; margin-top: 5px; opacity: 0.7;">(Sanitized by AI)</div>`
            }

            ui.receiverLog.appendChild(rxBubble);
            ui.receiverLog.scrollTop = ui.receiverLog.scrollHeight;
        }

        // Enter key support
        ui.input.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') send();
        });
    </script>
</body>
</html>